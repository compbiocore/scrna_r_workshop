```{r}
.libPaths(c('/usr/local/lib/R/site-library', '/usr/local/lib/R/library', '/tmp/RtmpTPz6Xo/downloaded_packages'))
#curl "https://singlecell.broadinstitute.org/single_cell/api/v1/bulk_download/generate_curl_config?accessions=SCP1699&auth_code=HVz2UKQV&directory=all&context=study"  -o cfg.txt; curl -K cfg.txt && rm cfg.txt
#curl "https://singlecell.broadinstitute.org/single_cell/api/v1/bulk_download/generate_curl_config?accessions=SCP1696&auth_code=rFbjcEmg&directory=all&context=study"  -o cfg.txt; curl -K cfg.txt && rm cfg.txt
```

```{r "setup"}
set.seed(61)
options(future.globals.maxSize = 4000 * 1024^5)
library(RColorBrewer)
library(Seurat)
library(patchwork)
library(ggplot2)
library(dplyr)
library(hdf5r)
library(stringr)
library(biomaRt)
library(kableExtra)
library(knitr)
library(pdftools)
library(viridis)
library(openxlsx)
library(SeuratDisk)
library(SeuratData)
library(ComplexHeatmap)
library(plotly)
```

```{r "import data"}
SCP1696 <- Read10X(data.dir = '/gpfs/data/cbc/scrna_r_workshop/SCP1696/expression/61b79702771a5b0dd6116d26')
SCP1699 <- Read10X(data.dir = '/gpfs/data/cbc/scrna_r_workshop/SCP1699/expression/61b7960c771a5b528ba5a820')
```

```{r "create seurat object"}
SCP1696 <- CreateSeuratObject(counts = SCP1696, project = 'SCP1696')
SCP1699 <- CreateSeuratObject(counts = SCP1699, project = 'SCP1699')
```

#https://satijalab.org/seurat/articles/merge_vignette.html
#merge() merges the raw count matrices of two Seurat objects and creates a new Seurat object with the resulting combined raw count matrix. To easily tell which original object any particular cell came from, you can set the add.cell.ids parameter with an c(x, y) vector, which will prepend the given identifier to the beginning of each cell name. The original project ID will remain stored in object meta data under orig.ident
```{r "merge"}
all_data <- merge(x = SCP1696, y = SCP1699, project = 'dm')
```

#the format of the mt sequences will vary depending on which organism/genome is used...
```{r "add mt percent data"}
all_data[["percent.mt"]] <- PercentageFeatureSet(all_data, pattern = "^mt:")
```

#https://www.google.com/url?sa=t&rct=j&q=&esrc=s&source=web&cd=&ved=2ahUKEwi9243gqoX3AhVvneAKHVD5B60QFnoECAUQAQ&url=https%3A%2F%2Fwww.bioinformatics.babraham.ac.uk%2Ftraining%2F10XRNASeq%2FIntroduction.pdf&usg=AOvVaw0d7gdoHTH4l3zVJgH5ikXD
#nFeature_RNA is the number of genes 
#nCount_RNA is the number of UMIs (unique molecules -- like counts) 
```{r  "QC plots"}
VlnPlot(all_data, features = "nFeature_RNA")
VlnPlot(all_data, features = "nCount_RNA")
VlnPlot(all_data, features="percent.mt")

FeatureScatter(all_data, feature1 = "nCount_RNA", feature2 = "percent.mt")
FeatureScatter(all_data, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
```

#pick your filtering based on your qc plots, mt filtering based on your understanding of the system or pubs

```{r "Data filtering"}
all_data_sub <- subset(all_data, subset = nFeature_RNA > 100 & nFeature_RNA < 2500 & percent.mt < 20)

```

```{r "SCTransform"}
all_data_split <- SplitObject(all_data_sub, split.by = 'orig.ident')

all_data_list <- lapply(all_data_split, function(x) {
    x <- SCTransform(x,verbose=FALSE) # if you run this you will get several iteration limit reached issues
})
```

```{r "Integration"}
all_data_list.features <- SelectIntegrationFeatures(object.list=all_data_list)

all_data_list <- PrepSCTIntegration(object.list=all_data_list, anchor.features=all_data_list.features, verbose=FALSE)

all_data.int.anchors <- FindIntegrationAnchors(all_data_list, normalization.method="SCT", anchor.features=all_data_list.features, verbose=FALSE)

all_data.combined <- IntegrateData(anchorset=all_data.int.anchors, normalization.method="SCT", verbose=FALSE)

DefaultAssay(all_data.combined) <- "integrated"

```

```{r "PCA"}
all_data.combined <- RunPCA(all_data.combined)

ElbowPlot(all_data.combined, ndims = 50)
#20 dims

VizDimLoadings(all_data.combined, dims = 1:5, reduction = "pca", nfeatures = 5)

DimPlot(all_data.combined, reduction = 'pca', group.by = 'orig.ident')
```

```{r "clustering"}
all_data.combined <- FindNeighbors(all_data.combined, dims = 1:30)
all_data.combined <- FindClusters(all_data.combined)
all_data.combined <- RunUMAP(all_data.combined, dims = 1:30)
all_data.combined <- RunTSNE(all_data.combined, tsne.method = "FIt-SNE", seed.use=61)
```

```{r "look at clusters"}
DimPlot(all_data.combined, reduction='tsne', split.by = 'orig.ident')
DimPlot(all_data.combined, reduction='umap', split.by = 'orig.ident')

```
```{r "look at a few summary tables to of cells per orig.ident and seurat cluster}
table(all_data.combined@meta.data$orig.ident)
table(all_data.combined@meta.data$seurat_clusters)
```
```{r "FindAllMarkers to find DE genes across clusters or per orig.ident}
Idents(all_data.combined) <- 'seurat_clusters'
DefaultAssay(all_data.combined) <- 'RNA'
cluster_markers <- FindAllMarkers(all_data.combined, only.pos = TRUE, assay = 'RNA')

Idents(all_data.combined) <- 'orig.ident'
ident_markers <- FindAllMarkers(all_data.combined, only.pos = TRUE, assay = 'RNA')
```

```{r "Look at some featureplots"}

FeaturePlot(all_data.combined, features = 'Msp300', reduction = 'tsne', split.by = 'orig.ident', order = T, keep.scale = 'all') & 
   scale_colour_gradientn(colours = rev(brewer.pal(n = 11, name = "Spectral"))) & 
   theme(legend.position = "right")

FeaturePlot(all_data.combined, features = 'Msp300', reduction = 'tsne', split.by = 'orig.ident', order = T, keep.scale = 'all') & 
   scale_colour_gradientn(limits = c(0,300),colours = rev(brewer.pal(n = 11, name = "Spectral"))) & 
   theme(legend.position = "right")

```
#still need to add bits about how to add annotations from cell atlas data

